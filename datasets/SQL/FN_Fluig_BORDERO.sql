

SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO


CREATE FUNCTION [dbo].[Fluig_BORDERO] ( @idfluig AS INT) 

RETURNS TABLE
AS

RETURN (	SELECT T1.*, 
			CASE 
			WHEN (SELECT [dbo].[Fluig_Autorizador_IDFLUIG] ( T1.FLUIG_MOV)) = 'Pool:Group:w_SG'		THEN 'simoneguimaraes'
			WHEN (SELECT [dbo].[Fluig_Autorizador_IDFLUIG] ( T1.FLUIG_MOV)) = 'Pool:Group:w_VPF'	THEN 'leandropinto'
			WHEN (SELECT [dbo].[Fluig_Autorizador_IDFLUIG] ( T1.FLUIG_MOV)) = 'Pool:Group:w_GP'		THEN 'lenouraschmidt'
			ELSE (SELECT [dbo].[Fluig_Autorizador_IDFLUIG] ( T1.FLUIG_MOV))
			END as ORDENADOR_DESPESA  FROM
				(SELECT 
					B.IDFLUIG
				,	B.IDBORDERO
				,	B.DESCRICAO DESC_BORDERO
				,	L.IDLAN
				,	F.NOMEFANTASIA AS FAVORECIDO
				,	L.NUMERODOCUMENTO
				,	convert(varchar,L.DATAPREVBAIXA,103) 	AS DATAPREVBAIXA
				,	convert(varchar,L.DATAVENCIMENTO,103) 	AS DATAVENCIMENTO
				,	dbo.FUNC_FORMATA_VALOR_MOEDA(L.VALORORIGINAL) AS VALORORIGINAL
				,	dbo.FUNC_FORMATA_VALOR_MOEDA(X.VALORBAIXA) AS VALORLIQUIDO
				,	M.MAX_VENCIMENTO
				,	M.TOT_VALORLIQUIDO
				,	(SELECT [dbo].[Idmov_Fluig] (L.IDMOV)) AS FLUIG_MOV
							FROM FBORDERO B(NOLOCK)
							JOIN FLAN L(NOLOCK) ON (B.CODCOLIGADA	=	L.CODCOLIGADA 
												AND B.CODCXA		=	L.CODCXA 
												AND B.IDBORDERO		=	L.IDBORDERO)
							JOIN FCFO F(NOLOCK) ON (L.CODCFO=F.CODCFO)
							LEFT JOIN FTRBLAN T(NOLOCK)	ON (L.IDLAN=T.IDLAN)
							JOIN FLANBAIXA X(NOLOCK) ON (L.IDLAN=X.IDLAN)

				LEFT JOIN (SELECT 	B.IDFLUIG
								,	MAX(convert(varchar,L.DATAPREVBAIXA,103)) 	AS MAX_VENCIMENTO			/* ATENÇÃO DATAPREVBAIXA */
								,	dbo.FUNC_FORMATA_VALOR_MOEDA(SUM(X.VALORBAIXA)) AS TOT_VALORLIQUIDO
												FROM FBORDERO B(NOLOCK)
												JOIN FLAN L(NOLOCK) ON (B.CODCOLIGADA	=	L.CODCOLIGADA 
																	AND B.CODCXA		=	L.CODCXA 
																	AND B.IDBORDERO		=	L.IDBORDERO)
												JOIN FCFO F(NOLOCK) ON (L.CODCFO=F.CODCFO)
												LEFT JOIN FTRBLAN T(NOLOCK)	ON (L.IDLAN=T.IDLAN)
												JOIN FLANBAIXA X(NOLOCK) ON (L.IDLAN=X.IDLAN)

									WHERE	X.DATACANCELBAIXA	IS NULL 
									AND		B.IDFLUIG			=	@idfluig
									GROUP BY B.IDFLUIG	)M ON (B.IDFLUIG=M.IDFLUIG)

				WHERE	X.DATACANCELBAIXA	IS NULL 
				AND		B.IDFLUIG			=	@idfluig
				)T1
)

				/*
				,	CASE 
					WHEN ( SELECT [dbo].[Idmov_Fluig] (L.IDMOV)) IS NOT NULL	THEN CONVERT(VARCHAR(20),(SELECT [dbo].[Idmov_Fluig] (L.IDMOV)))	-- Coleta ID do FLuig em qualquer movimento
					WHEN ( SELECT [dbo].[Idmov_Origem] (L.IDMOV)) IS NOT NULL THEN ( SELECT CONVERT(VARCHAR(20),TTMV.NOME) FROM TMOV 
																					JOIN TTMV ON (TMOV.CODTMV=TTMV.CODTMV) 
																					WHERE TMOV.IDMOV IN 
																					(SELECT [dbo].[Idmov_Origem] (L.IDMOV))) 
					ELSE CONVERT(VARCHAR(20),(SELECT [dbo].[Idmov_Fluig] (L.IDMOV)))
					END AS FLUIG_MOV
				*/


GO


