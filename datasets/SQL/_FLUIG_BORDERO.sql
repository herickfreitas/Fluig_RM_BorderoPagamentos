USE [Corporerm_Homolog]
GO

/****** Object:  View [dbo].[_Fluig_BORDERO]    Script Date: 08/03/2021 10:18:02 ******/
SET ANSI_NULLS OFF
GO

SET QUOTED_IDENTIFIER OFF
GO




CREATE VIEW [dbo].[_Fluig_BORDERO] AS

SELECT 
	B.IDFLUIG
,	B.IDBORDERO
,	B.DESCRICAO DESC_BORDERO
,	L.IDLAN
,	F.NOMEFANTASIA AS FAVORECIDO
,	L.NUMERODOCUMENTO
,	convert(varchar,L.DATAPREVBAIXA,103) 	AS DATAPREVBAIXA
,	convert(varchar,L.DATAVENCIMENTO,103) 	AS DATAVENCIMENTO
,	dbo.FUNC_FORMATA_VALOR_MOEDA(L.VALORORIGINAL) AS VALORORIGINAL
,	dbo.FUNC_FORMATA_VALOR_MOEDA(X.VALORBAIXA) AS VALORLIQUIDO
,	M.MAX_VENCIMENTO
,	M.TOT_VALORLIQUIDO
--,	(SELECT [dbo].[Idmov_Fluig] (L.IDMOV)) AS FLUIG_MOV
,	CASE 
	WHEN ( SELECT [dbo].[Idmov_Fluig] (L.IDMOV)) IS NOT NULL	THEN CONVERT(VARCHAR(20),(SELECT [dbo].[Idmov_Fluig] (L.IDMOV)))	-- Coleta ID do FLuig em qualquer movimento
	WHEN ( SELECT [dbo].[Idmov_Origem] (L.IDMOV)) IS NOT NULL THEN ( SELECT CONVERT(VARCHAR(20),TTMV.NOME) FROM TMOV 
																	JOIN TTMV ON (TMOV.CODTMV=TTMV.CODTMV) 
																	WHERE TMOV.IDMOV IN 
																	(SELECT [dbo].[Idmov_Origem] (L.IDMOV))) 
	ELSE CONVERT(VARCHAR(20),(SELECT [dbo].[Idmov_Fluig] (L.IDMOV)))
	END AS FLUIG_MOV

			FROM FBORDERO B(NOLOCK)
			JOIN FLAN L(NOLOCK) ON (B.CODCOLIGADA	=	L.CODCOLIGADA 
								AND B.CODCXA		=	L.CODCXA 
								AND B.IDBORDERO		=	L.IDBORDERO)
			JOIN FCFO F(NOLOCK) ON (L.CODCFO=F.CODCFO)
			LEFT JOIN FTRBLAN T(NOLOCK)	ON (L.IDLAN=T.IDLAN)
			JOIN FLANBAIXA X(NOLOCK) ON (L.IDLAN=X.IDLAN)

LEFT JOIN (SELECT 	B.IDFLUIG
				,	MAX(convert(varchar,L.DATAPREVBAIXA,103)) 	AS MAX_VENCIMENTO			/* ATENÇÃO DATAPREVBAIXA */
				,	dbo.FUNC_FORMATA_VALOR_MOEDA(SUM(X.VALORBAIXA)) AS TOT_VALORLIQUIDO
								FROM FBORDERO B(NOLOCK)
								JOIN FLAN L(NOLOCK) ON (B.CODCOLIGADA	=	L.CODCOLIGADA 
													AND B.CODCXA		=	L.CODCXA 
													AND B.IDBORDERO		=	L.IDBORDERO)
								JOIN FCFO F(NOLOCK) ON (L.CODCFO=F.CODCFO)
								LEFT JOIN FTRBLAN T(NOLOCK)	ON (L.IDLAN=T.IDLAN)
								JOIN FLANBAIXA X(NOLOCK) ON (L.IDLAN=X.IDLAN)

					WHERE	X.DATACANCELBAIXA	IS NULL 
					AND		B.IDFLUIG			IS NOT NULL
					GROUP BY B.IDFLUIG	)M ON (B.IDFLUIG=M.IDFLUIG)

WHERE	X.DATACANCELBAIXA	IS NULL 
AND		B.IDFLUIG			IS NOT NULL
GO

